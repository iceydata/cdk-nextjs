"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Nextjs = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const fs = require("node:fs");
const os = require("os");
const path = require("path");
const constructs_1 = require("constructs");
const NextjsBuild_1 = require("./NextjsBuild");
const NextjsDistribution_1 = require("./NextjsDistribution");
const NextjsImage_1 = require("./NextjsImage");
const NextjsInvalidation_1 = require("./NextjsInvalidation");
const NextjsRevalidation_1 = require("./NextjsRevalidation");
const NextjsServer_1 = require("./NextjsServer");
const NextjsStaticAssets_1 = require("./NextjsStaticAssets");
/**
 * The `Nextjs` construct is a higher level construct that makes it easy to create a NextJS app.
 *
 * Your standalone server application will be bundled using o(utput tracing and will be deployed to a Lambda function.
 * Static assets will be deployed to an S3 bucket and served via CloudFront.
 * You must use Next.js 10.3.0 or newer.
 *
 * Please provide a `nextjsPath` to the Next.js app inside your project.
 *
 * @example
 * new Nextjs(this, "Web", {
 *   nextjsPath: path.resolve("packages/web"),
 * })
 */
class Nextjs extends constructs_1.Construct {
    /**
     * Where build-time assets for deployment are stored.
     */
    get tempBuildDir() {
        return this.props.tempBuildDir
            ? path.resolve(path.join(this.props.tempBuildDir, `nextjs-cdk-build-${this.node.id}-${this.node.addr.substring(0, 4)}`))
            : fs.mkdtempSync(path.join(os.tmpdir(), 'nextjs-cdk-build-'));
    }
    constructor(scope, id, props) {
        super(scope, id);
        this.props = props;
        // build nextjs app
        this.nextBuild = new NextjsBuild_1.NextjsBuild(this, id, { ...props, tempBuildDir: this.tempBuildDir });
        // deploy nextjs static assets to s3
        this.staticAssets = new NextjsStaticAssets_1.NextjsStaticAssets(this, 'StaticAssets', {
            bucket: props.defaults?.assetDeployment?.bucket,
            environment: props.environment,
            nextBuild: this.nextBuild,
        });
        this.serverFunction = new NextjsServer_1.NextjsServer(this, 'Server', {
            ...props,
            tempBuildDir: this.tempBuildDir,
            nextBuild: this.nextBuild,
            lambda: props.defaults?.lambda,
            staticAssetBucket: this.staticAssets.bucket,
        });
        // build image optimization
        this.imageOptimizationFunction = new NextjsImage_1.NextjsImage(this, 'ImgOptFn', {
            ...props,
            nextBuild: this.nextBuild,
            bucket: props.imageOptimizationBucket || this.bucket,
            lambdaOptions: props.defaults?.lambda,
        });
        // build revalidation queue and handler function
        this.revalidation = new NextjsRevalidation_1.NextjsRevalidation(this, 'Revalidation', {
            ...props,
            nextBuild: this.nextBuild,
            serverFunction: this.serverFunction,
        });
        this.distribution = new NextjsDistribution_1.NextjsDistribution(this, 'Distribution', {
            ...props,
            ...props.defaults?.distribution,
            staticAssetsBucket: this.staticAssets.bucket,
            tempBuildDir: this.tempBuildDir,
            nextBuild: this.nextBuild,
            serverFunction: this.serverFunction.lambdaFunction,
            imageOptFunction: this.imageOptimizationFunction,
        });
        if (!this.props.skipFullInvalidation) {
            new NextjsInvalidation_1.NextjsInvalidation(this, 'Invalidation', {
                distribution: this.distribution.distribution,
                dependencies: [], // [this.staticAssets, this.serverFunction, this.imageOptimizationFunction]
            });
        }
    }
    /**
     * URL of Next.js App.
     */
    get url() {
        const customDomain = this.distribution.customDomainName;
        return customDomain ? `https://${customDomain}` : this.distribution.url;
    }
    /**
     * Convenience method to access `Nextjs.staticAssets.bucket`.
     */
    get bucket() {
        return this.staticAssets.bucket;
    }
}
_a = JSII_RTTI_SYMBOL_1;
Nextjs[_a] = { fqn: "cdk-nextjs-standalone.Nextjs", version: "4.0.0-beta.3" };
exports.Nextjs = Nextjs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL05leHRqcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLDhCQUE4QjtBQUM5Qix5QkFBeUI7QUFDekIsNkJBQTZCO0FBSTdCLDJDQUF1QztBQUV2QywrQ0FBNEM7QUFDNUMsNkRBQW1GO0FBQ25GLCtDQUE0QztBQUM1Qyw2REFBMEQ7QUFDMUQsNkRBQTBEO0FBQzFELGlEQUE4QztBQUM5Qyw2REFBbUY7QUE2Q25GOzs7Ozs7Ozs7Ozs7O0dBYUc7QUFDSCxNQUFhLE1BQU8sU0FBUSxzQkFBUztJQTBCbkM7O09BRUc7SUFDSCxJQUFXLFlBQVk7UUFDckIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVk7WUFDNUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQ1YsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxvQkFBb0IsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQ3pHO1lBQ0gsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFVRCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFZLEtBQWtCO1FBQ3BFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFEaUMsVUFBSyxHQUFMLEtBQUssQ0FBYTtRQUdwRSxtQkFBbUI7UUFDbkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLHlCQUFXLENBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsS0FBSyxFQUFFLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUUxRixvQ0FBb0M7UUFDcEMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLHVDQUFrQixDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7WUFDL0QsTUFBTSxFQUFFLEtBQUssQ0FBQyxRQUFRLEVBQUUsZUFBZSxFQUFFLE1BQU07WUFDL0MsV0FBVyxFQUFFLEtBQUssQ0FBQyxXQUFXO1lBQzlCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztTQUMxQixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksMkJBQVksQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFO1lBQ3JELEdBQUcsS0FBSztZQUNSLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtZQUMvQixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsTUFBTSxFQUFFLEtBQUssQ0FBQyxRQUFRLEVBQUUsTUFBTTtZQUM5QixpQkFBaUIsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU07U0FDNUMsQ0FBQyxDQUFDO1FBQ0gsMkJBQTJCO1FBQzNCLElBQUksQ0FBQyx5QkFBeUIsR0FBRyxJQUFJLHlCQUFXLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtZQUNqRSxHQUFHLEtBQUs7WUFDUixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsTUFBTSxFQUFFLEtBQUssQ0FBQyx1QkFBdUIsSUFBSSxJQUFJLENBQUMsTUFBTTtZQUNwRCxhQUFhLEVBQUUsS0FBSyxDQUFDLFFBQVEsRUFBRSxNQUFNO1NBQ3RDLENBQUMsQ0FBQztRQUVILGdEQUFnRDtRQUNoRCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksdUNBQWtCLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRTtZQUMvRCxHQUFHLEtBQUs7WUFDUixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsY0FBYyxFQUFFLElBQUksQ0FBQyxjQUFjO1NBQ3BDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSx1Q0FBa0IsQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFO1lBQy9ELEdBQUcsS0FBSztZQUNSLEdBQUcsS0FBSyxDQUFDLFFBQVEsRUFBRSxZQUFZO1lBQy9CLGtCQUFrQixFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTTtZQUM1QyxZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVk7WUFDL0IsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLGNBQWM7WUFDbEQsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLHlCQUF5QjtTQUNqRCxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsRUFBRTtZQUNwQyxJQUFJLHVDQUFrQixDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7Z0JBQzNDLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVk7Z0JBQzVDLFlBQVksRUFBRSxFQUFFLEVBQUUsMkVBQTJFO2FBQzlGLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBVyxHQUFHO1FBQ1osTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztRQUN4RCxPQUFPLFlBQVksQ0FBQyxDQUFDLENBQUMsV0FBVyxZQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUM7SUFDMUUsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBVyxNQUFNO1FBQ2YsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQztJQUNsQyxDQUFDOzs7O0FBL0dVLHdCQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnbm9kZTpmcyc7XG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRnVuY3Rpb25PcHRpb25zIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgKiBhcyBzMyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtczMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBCYXNlU2l0ZURvbWFpblByb3BzLCBOZXh0anNCYXNlUHJvcHMgfSBmcm9tICcuL05leHRqc0Jhc2UnO1xuaW1wb3J0IHsgTmV4dGpzQnVpbGQgfSBmcm9tICcuL05leHRqc0J1aWxkJztcbmltcG9ydCB7IE5leHRqc0Rpc3RyaWJ1dGlvbiwgTmV4dGpzRGlzdHJpYnV0aW9uUHJvcHMgfSBmcm9tICcuL05leHRqc0Rpc3RyaWJ1dGlvbic7XG5pbXBvcnQgeyBOZXh0anNJbWFnZSB9IGZyb20gJy4vTmV4dGpzSW1hZ2UnO1xuaW1wb3J0IHsgTmV4dGpzSW52YWxpZGF0aW9uIH0gZnJvbSAnLi9OZXh0anNJbnZhbGlkYXRpb24nO1xuaW1wb3J0IHsgTmV4dGpzUmV2YWxpZGF0aW9uIH0gZnJvbSAnLi9OZXh0anNSZXZhbGlkYXRpb24nO1xuaW1wb3J0IHsgTmV4dGpzU2VydmVyIH0gZnJvbSAnLi9OZXh0anNTZXJ2ZXInO1xuaW1wb3J0IHsgTmV4dGpzU3RhdGljQXNzZXRzLCBOZXh0anNTdGF0aWNBc3NldHNQcm9wcyB9IGZyb20gJy4vTmV4dGpzU3RhdGljQXNzZXRzJztcblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNEb21haW5Qcm9wcyBleHRlbmRzIEJhc2VTaXRlRG9tYWluUHJvcHMge31cblxuLyoqXG4gKiBEZWZhdWx0cyBmb3IgY3JlYXRlZCByZXNvdXJjZXMuXG4gKiBXaHkgYGFueWA/IHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXdzL2pzaWkvaXNzdWVzLzI5MDFcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBOZXh0anNEZWZhdWx0c1Byb3BzIHtcbiAgLyoqXG4gICAqIE92ZXJyaWRlIHN0YXRpYyBmaWxlIGRlcGxveW1lbnQgc2V0dGluZ3MuXG4gICAqL1xuICByZWFkb25seSBhc3NldERlcGxveW1lbnQ/OiBOZXh0anNTdGF0aWNBc3NldHNQcm9wcyB8IGFueTtcblxuICAvKipcbiAgICogT3ZlcnJpZGUgc2VydmVyIGxhbWJkYSBmdW5jdGlvbiBzZXR0aW5ncy5cbiAgICovXG4gIHJlYWRvbmx5IGxhbWJkYT86IEZ1bmN0aW9uT3B0aW9ucztcblxuICAvKipcbiAgICogT3ZlcnJpZGUgQ2xvdWRGcm9udCBkaXN0cmlidXRpb24gc2V0dGluZ3MuXG4gICAqXG4gICAqIFRoZXNlIHByb3BlcnRpZXMgc2hvdWxkIGFsbCBiZSBvcHRpb25hbCBidXQgY2Fubm90IGJlIGR1ZSB0byBhIGxpbWl0YXRpb24gaW4ganNpaS5cbiAgICovXG4gIHJlYWRvbmx5IGRpc3RyaWJ1dGlvbj86IE5leHRqc0Rpc3RyaWJ1dGlvblByb3BzIHwgYW55O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE5leHRqc1Byb3BzIGV4dGVuZHMgTmV4dGpzQmFzZVByb3BzIHtcbiAgLyoqXG4gICAqIE9wdGlvbmFsIFMzIEJ1Y2tldCB0byB1c2UsIGRlZmF1bHRzIHRvIGFzc2V0cyBidWNrZXRcbiAgICovXG4gIHJlYWRvbmx5IGltYWdlT3B0aW1pemF0aW9uQnVja2V0PzogczMuSUJ1Y2tldDtcbiAgLyoqXG4gICAqIEFsbG93cyB5b3UgdG8gb3ZlcnJpZGUgZGVmYXVsdHMgZm9yIHRoZSByZXNvdXJjZXMgY3JlYXRlZCBieSB0aGlzXG4gICAqIGNvbnN0cnVjdC5cbiAgICovXG4gIHJlYWRvbmx5IGRlZmF1bHRzPzogTmV4dGpzRGVmYXVsdHNQcm9wcztcbiAgLyoqXG4gICAqIFNraXBzIHJ1bm5pbmcgTmV4dC5qcyBidWlsZC4gVXNlZnVsIGlmIHlvdSB3YW50IHRvIGRlcGxveSBgTmV4dGpzYCBidXRcbiAgICogaGF2ZW4ndCBtYWRlIGFueSBjaGFuZ2VzIHRvIE5leHQuanMgYXBwIGNvZGUuXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBza2lwQnVpbGQ/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIFRoZSBgTmV4dGpzYCBjb25zdHJ1Y3QgaXMgYSBoaWdoZXIgbGV2ZWwgY29uc3RydWN0IHRoYXQgbWFrZXMgaXQgZWFzeSB0byBjcmVhdGUgYSBOZXh0SlMgYXBwLlxuICpcbiAqIFlvdXIgc3RhbmRhbG9uZSBzZXJ2ZXIgYXBwbGljYXRpb24gd2lsbCBiZSBidW5kbGVkIHVzaW5nIG8odXRwdXQgdHJhY2luZyBhbmQgd2lsbCBiZSBkZXBsb3llZCB0byBhIExhbWJkYSBmdW5jdGlvbi5cbiAqIFN0YXRpYyBhc3NldHMgd2lsbCBiZSBkZXBsb3llZCB0byBhbiBTMyBidWNrZXQgYW5kIHNlcnZlZCB2aWEgQ2xvdWRGcm9udC5cbiAqIFlvdSBtdXN0IHVzZSBOZXh0LmpzIDEwLjMuMCBvciBuZXdlci5cbiAqXG4gKiBQbGVhc2UgcHJvdmlkZSBhIGBuZXh0anNQYXRoYCB0byB0aGUgTmV4dC5qcyBhcHAgaW5zaWRlIHlvdXIgcHJvamVjdC5cbiAqXG4gKiBAZXhhbXBsZVxuICogbmV3IE5leHRqcyh0aGlzLCBcIldlYlwiLCB7XG4gKiAgIG5leHRqc1BhdGg6IHBhdGgucmVzb2x2ZShcInBhY2thZ2VzL3dlYlwiKSxcbiAqIH0pXG4gKi9cbmV4cG9ydCBjbGFzcyBOZXh0anMgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICAvKipcbiAgICogVGhlIG1haW4gTmV4dEpTIHNlcnZlciBoYW5kbGVyIGxhbWJkYSBmdW5jdGlvbi5cbiAgICovXG4gIHB1YmxpYyBzZXJ2ZXJGdW5jdGlvbjogTmV4dGpzU2VydmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgaW1hZ2Ugb3B0aW1pemF0aW9uIGhhbmRsZXIgbGFtYmRhIGZ1bmN0aW9uLlxuICAgKi9cbiAgcHVibGljIGltYWdlT3B0aW1pemF0aW9uRnVuY3Rpb246IE5leHRqc0ltYWdlO1xuXG4gIC8qKlxuICAgKiBCdWlsdCBOZXh0SlMgcHJvamVjdCBvdXRwdXQuXG4gICAqL1xuICBwdWJsaWMgbmV4dEJ1aWxkOiBOZXh0anNCdWlsZDtcblxuICAvKipcbiAgICogQXNzZXQgZGVwbG95bWVudCB0byBTMy5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWNBc3NldHM6IE5leHRqc1N0YXRpY0Fzc2V0cztcblxuICAvKipcbiAgICogQ2xvdWRGcm9udCBkaXN0cmlidXRpb24uXG4gICAqL1xuICBwdWJsaWMgZGlzdHJpYnV0aW9uOiBOZXh0anNEaXN0cmlidXRpb247XG5cbiAgLyoqXG4gICAqIFdoZXJlIGJ1aWxkLXRpbWUgYXNzZXRzIGZvciBkZXBsb3ltZW50IGFyZSBzdG9yZWQuXG4gICAqL1xuICBwdWJsaWMgZ2V0IHRlbXBCdWlsZERpcigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnByb3BzLnRlbXBCdWlsZERpclxuICAgICAgPyBwYXRoLnJlc29sdmUoXG4gICAgICAgICAgcGF0aC5qb2luKHRoaXMucHJvcHMudGVtcEJ1aWxkRGlyLCBgbmV4dGpzLWNkay1idWlsZC0ke3RoaXMubm9kZS5pZH0tJHt0aGlzLm5vZGUuYWRkci5zdWJzdHJpbmcoMCwgNCl9YClcbiAgICAgICAgKVxuICAgICAgOiBmcy5ta2R0ZW1wU3luYyhwYXRoLmpvaW4ob3MudG1wZGlyKCksICduZXh0anMtY2RrLWJ1aWxkLScpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXZhbGlkYXRpb24gaGFuZGxlciBhbmQgcXVldWUuXG4gICAqL1xuICBwdWJsaWMgcmV2YWxpZGF0aW9uOiBOZXh0anNSZXZhbGlkYXRpb247XG5cbiAgcHVibGljIGxhbWJkYUZ1bmN0aW9uVXJsITogbGFtYmRhLkZ1bmN0aW9uVXJsO1xuICBwdWJsaWMgaW1hZ2VPcHRpbWl6YXRpb25MYW1iZGFGdW5jdGlvblVybCE6IGxhbWJkYS5GdW5jdGlvblVybDtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm90ZWN0ZWQgcHJvcHM6IE5leHRqc1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIC8vIGJ1aWxkIG5leHRqcyBhcHBcbiAgICB0aGlzLm5leHRCdWlsZCA9IG5ldyBOZXh0anNCdWlsZCh0aGlzLCBpZCwgeyAuLi5wcm9wcywgdGVtcEJ1aWxkRGlyOiB0aGlzLnRlbXBCdWlsZERpciB9KTtcblxuICAgIC8vIGRlcGxveSBuZXh0anMgc3RhdGljIGFzc2V0cyB0byBzM1xuICAgIHRoaXMuc3RhdGljQXNzZXRzID0gbmV3IE5leHRqc1N0YXRpY0Fzc2V0cyh0aGlzLCAnU3RhdGljQXNzZXRzJywge1xuICAgICAgYnVja2V0OiBwcm9wcy5kZWZhdWx0cz8uYXNzZXREZXBsb3ltZW50Py5idWNrZXQsXG4gICAgICBlbnZpcm9ubWVudDogcHJvcHMuZW52aXJvbm1lbnQsXG4gICAgICBuZXh0QnVpbGQ6IHRoaXMubmV4dEJ1aWxkLFxuICAgIH0pO1xuXG4gICAgdGhpcy5zZXJ2ZXJGdW5jdGlvbiA9IG5ldyBOZXh0anNTZXJ2ZXIodGhpcywgJ1NlcnZlcicsIHtcbiAgICAgIC4uLnByb3BzLFxuICAgICAgdGVtcEJ1aWxkRGlyOiB0aGlzLnRlbXBCdWlsZERpcixcbiAgICAgIG5leHRCdWlsZDogdGhpcy5uZXh0QnVpbGQsXG4gICAgICBsYW1iZGE6IHByb3BzLmRlZmF1bHRzPy5sYW1iZGEsXG4gICAgICBzdGF0aWNBc3NldEJ1Y2tldDogdGhpcy5zdGF0aWNBc3NldHMuYnVja2V0LFxuICAgIH0pO1xuICAgIC8vIGJ1aWxkIGltYWdlIG9wdGltaXphdGlvblxuICAgIHRoaXMuaW1hZ2VPcHRpbWl6YXRpb25GdW5jdGlvbiA9IG5ldyBOZXh0anNJbWFnZSh0aGlzLCAnSW1nT3B0Rm4nLCB7XG4gICAgICAuLi5wcm9wcyxcbiAgICAgIG5leHRCdWlsZDogdGhpcy5uZXh0QnVpbGQsXG4gICAgICBidWNrZXQ6IHByb3BzLmltYWdlT3B0aW1pemF0aW9uQnVja2V0IHx8IHRoaXMuYnVja2V0LFxuICAgICAgbGFtYmRhT3B0aW9uczogcHJvcHMuZGVmYXVsdHM/LmxhbWJkYSxcbiAgICB9KTtcblxuICAgIC8vIGJ1aWxkIHJldmFsaWRhdGlvbiBxdWV1ZSBhbmQgaGFuZGxlciBmdW5jdGlvblxuICAgIHRoaXMucmV2YWxpZGF0aW9uID0gbmV3IE5leHRqc1JldmFsaWRhdGlvbih0aGlzLCAnUmV2YWxpZGF0aW9uJywge1xuICAgICAgLi4ucHJvcHMsXG4gICAgICBuZXh0QnVpbGQ6IHRoaXMubmV4dEJ1aWxkLFxuICAgICAgc2VydmVyRnVuY3Rpb246IHRoaXMuc2VydmVyRnVuY3Rpb24sXG4gICAgfSk7XG5cbiAgICB0aGlzLmRpc3RyaWJ1dGlvbiA9IG5ldyBOZXh0anNEaXN0cmlidXRpb24odGhpcywgJ0Rpc3RyaWJ1dGlvbicsIHtcbiAgICAgIC4uLnByb3BzLFxuICAgICAgLi4ucHJvcHMuZGVmYXVsdHM/LmRpc3RyaWJ1dGlvbixcbiAgICAgIHN0YXRpY0Fzc2V0c0J1Y2tldDogdGhpcy5zdGF0aWNBc3NldHMuYnVja2V0LFxuICAgICAgdGVtcEJ1aWxkRGlyOiB0aGlzLnRlbXBCdWlsZERpcixcbiAgICAgIG5leHRCdWlsZDogdGhpcy5uZXh0QnVpbGQsXG4gICAgICBzZXJ2ZXJGdW5jdGlvbjogdGhpcy5zZXJ2ZXJGdW5jdGlvbi5sYW1iZGFGdW5jdGlvbixcbiAgICAgIGltYWdlT3B0RnVuY3Rpb246IHRoaXMuaW1hZ2VPcHRpbWl6YXRpb25GdW5jdGlvbixcbiAgICB9KTtcblxuICAgIGlmICghdGhpcy5wcm9wcy5za2lwRnVsbEludmFsaWRhdGlvbikge1xuICAgICAgbmV3IE5leHRqc0ludmFsaWRhdGlvbih0aGlzLCAnSW52YWxpZGF0aW9uJywge1xuICAgICAgICBkaXN0cmlidXRpb246IHRoaXMuZGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbixcbiAgICAgICAgZGVwZW5kZW5jaWVzOiBbXSwgLy8gW3RoaXMuc3RhdGljQXNzZXRzLCB0aGlzLnNlcnZlckZ1bmN0aW9uLCB0aGlzLmltYWdlT3B0aW1pemF0aW9uRnVuY3Rpb25dXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVVJMIG9mIE5leHQuanMgQXBwLlxuICAgKi9cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICBjb25zdCBjdXN0b21Eb21haW4gPSB0aGlzLmRpc3RyaWJ1dGlvbi5jdXN0b21Eb21haW5OYW1lO1xuICAgIHJldHVybiBjdXN0b21Eb21haW4gPyBgaHR0cHM6Ly8ke2N1c3RvbURvbWFpbn1gIDogdGhpcy5kaXN0cmlidXRpb24udXJsO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlbmllbmNlIG1ldGhvZCB0byBhY2Nlc3MgYE5leHRqcy5zdGF0aWNBc3NldHMuYnVja2V0YC5cbiAgICovXG4gIHB1YmxpYyBnZXQgYnVja2V0KCk6IHMzLklCdWNrZXQge1xuICAgIHJldHVybiB0aGlzLnN0YXRpY0Fzc2V0cy5idWNrZXQ7XG4gIH1cbn1cbiJdfQ==